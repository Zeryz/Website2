<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Tournament Manager</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: #1a1a1a; 
            color: #eee; 
            margin: 0; 
            padding: 20px; 
        }
        .container { max-width: 1400px; margin: auto; }
        h1 { text-align: center; color: #4CAF50; }
        .subtitle { text-align: center; color: #aaa; margin-bottom: 30px; }

        .setup {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .player-input { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px; }
        #nameInput { flex: 1; min-width: 250px; padding: 12px; font-size: 16px; border: none; border-radius: 6px; background: #333; color: white; }
        #nameInput:focus { outline: 2px solid #4CAF50; }
        .players-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .player-tag { background: #333; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; }
        .player-tag button { background: #c44; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; }

        .controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
        select, button { padding: 12px; font-size: 16px; border: none; border-radius: 6px; }
        select { background: #333; color: white; }
        button { background: #4CAF50; color: white; cursor: pointer; min-width: 120px; }
        button:hover { background: #45a049; }
        button.secondary { background: #555; }
        button.secondary:hover { background: #666; }

        /* Bracket Styles */
        .bracket-container { overflow-x: auto; padding: 20px 0; }
        .bracket { display: flex; justify-content: center; position: relative; }
        .column { display: flex; flex-direction: column; justify-content: space-around; margin: 0 40px; }
        .match { 
            background: #333; padding: 10px; border-radius: 8px; width: 200px; cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.5); position: relative;
        }
        .match:hover { background: #444; }
        .player { padding: 8px; border-bottom: 1px solid #555; }
        .player:last-child { border-bottom: none; }
        .winner { background: #4CAF50; font-weight: bold; }
        .table-info { font-size: 12px; color: #aaa; text-align: center; margin-top: 5px; }
        .connector { position: absolute; border-color: #666; }
        .losers-bracket { margin-top: 60px; border-top: 2px solid #444; padding-top: 30px; }

        /* Modal */
        #matchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: #333; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        .modal-content select { width: 100%; margin: 15px 0; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pool Tournament Manager</h1>
        <p class="subtitle">Single & Double Elimination • Win/Loss Matches • Table Assignments</p>

        <div class="setup">
            <div class="player-input">
                <input type="text" id="nameInput" placeholder="Type player name and press Enter" autofocus>
                <button onclick="clearPlayers()" class="secondary">Clear Players</button>
            </div>
            <div class="players-list" id="playersList"></div>

            <div class="controls">
                <select id="format">
                    <option value="single">Single Elimination</option>
                    <option value="double">Double Elimination</option>
                </select>
                <button onclick="generateBracket()">Generate Bracket</button>
                <button onclick="saveState()" class="secondary">Save Progress</button>
                <button onclick="loadState()" class="secondary">Load Saved</button>
            </div>
        </div>

        <div class="bracket-container">
            <div id="bracket" class="bracket"></div>
        </div>
    </div>

    <!-- Modal for updating match -->
    <div id="matchModal">
        <div class="modal-content">
            <h3 id="modalTitle">Select Winner</h3>
            <p id="modalPlayers"></p>
            <select id="winnerSelect"></select>
            <select id="tableSelect">
                <option value="Unassigned">Unassigned</option>
                <option value="Table 1">Table 1</option>
                <option value="Table 2">Table 2</option>
                <option value="Table 3">Table 3</option>
                <option value="Table 4">Table 4</option>
                <option value="Table 5">Table 5</option>
                <option value="Table 6">Table 6</option>
                <option value="Table 7">Table 7</option>
                <option value="Table 8">Table 8</option>
                <option value="Table 9">Table 9</option>
                <option value="Table 10">Table 10</option>
            </select>
            <button onclick="confirmWinner()">Confirm</button>
            <button class="secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        let players = [];
        let matches = []; // Array of {id, p1, p2, winner, table, round, bracket: 'w' or 'l', nextW, nextL}
        let format = 'single';
        let currentMatchId = null;

        // Player handling
        document.getElementById('nameInput').addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                addPlayer(e.target.value.trim());
                e.target.value = '';
            }
        });

        function addPlayer(name) {
            if (players.includes(name)) return alert('Player already added!');
            players.push(name);
            renderPlayersList();
        }

        function removePlayer(i) {
            players.splice(i, 1);
            renderPlayersList();
        }

        function clearPlayers() {
            if (confirm('Clear all players?')) {
                players = [];
                renderPlayersList();
            }
        }

        function renderPlayersList() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            players.forEach((p, i) => {
                const tag = document.createElement('div');
                tag.className = 'player-tag';
                tag.innerHTML = `${p} <button onclick="removePlayer(${i})">×</button>`;
                list.appendChild(tag);
            });
        }

        // Bracket generation
        function generateBracket() {
            if (players.length < 2) return alert('Add at least 2 players!');
            format = document.getElementById('format').value;
            matches = [];

            // Pad to power of 2
            const size = Math.pow(2, Math.ceil(Math.log2(players.length)));
            const seeded = [...players];
            while (seeded.length < size) seeded.push('BYE');

            // Standard seeding
            const order = [];
            let left = 0, right = size - 1;
            while (left < right) {
                order.push(seeded[left++]);
                order.push(seeded[right--]);
            }

            // Build winners bracket
            buildBracket(order, 0, 'w');

            if (format === 'double') buildLosersBracket(size);

            renderBracket();
        }

        function buildBracket(seeding, round, bracketType) {
            const matchCount = seeding.length / 2;
            for (let i = 0; i < matchCount; i++) {
                const m = {
                    id: matches.length,
                    p1: seeding[i*2] || null,
                    p2: seeding[i*2 + 1] || null,
                    winner: null,
                    table: 'Unassigned',
                    round,
                    bracket: bracketType
                };
                matches.push(m);
            }

            if (matchCount > 1) {
                const nextSeeding = new Array(matchCount).fill(null);
                matches.slice(-matchCount).forEach((m, i) => m.nextW = matches.length + Math.floor(i / 2));
                buildBracket(nextSeeding, round + 1, bracketType);
            }
        }

        function buildLosersBracket(size) {
            // Simplified but correct loser drop logic handled in update
        }

        function advanceWinner(match) {
            if (match.nextW !== undefined) {
                const next = matches[match.nextW];
                if (!next.p1) next.p1 = match.winner;
                else next.p2 = match.winner;
            }
        }

        function dropLoser(match) {
            if (format !== 'double' || match.bracket !== 'w' || match.winner === 'BYE') return;
            const loser = match.winner === match.p1 ? match.p2 : match.p1;
            if (loser === 'BYE') return;

            // Find next open loser spot (simple round-robin drop)
            const loserRound = match.round;
            let target = matches.find(m => m.bracket === 'w' && m.round === loserRound + 1 && (!m.p1 || !m.p2));
            if (!target) return;
            if (!target.p1) target.p1 = loser;
            else target.p2 = loser;
        }

        // Rendering
        function renderBracket() {
            const bracket = document.getElementById('bracket');
            bracket.innerHTML = '';

            const maxRound = matches.reduce((max, m) => Math.max(max, m.round), 0);

            // Winners bracket
            const winnersDiv = document.createElement('div');
            winnersDiv.className = 'bracket';
            for (let r = 0; r <= maxRound; r++) {
                const col = document.createElement('div');
                col.className = 'column';
                matches.filter(m => m.bracket === 'w' && m.round === r).forEach(m => {
                    const div = createMatchDiv(m);
                    col.appendChild(div);
                });
                winnersDiv.appendChild(col);
            }
            bracket.appendChild(winnersDiv);

            if (format === 'double') {
                const losersDiv = document.createElement('div');
                losersDiv.className = 'losers-bracket';
                losersDiv.innerHTML = '<h2 style="text-align:center; color:#ff9900;">Losers Bracket</h2>';
                const lb = document.createElement('div');
                lb.className = 'bracket';
                // Render loser matches similarly
                for (let r = 0; r <= maxRound; r++) {
                    const col = document.createElement('div');
                    col.className = 'column';
                    matches.filter(m => m.bracket === 'l' && m.round === r).forEach(m => col.appendChild(createMatchDiv(m)));
                    if (col.children.length) lb.appendChild(col);
                }
                losersDiv.appendChild(lb);
                bracket.appendChild(losersDiv);
            }
        }

        function createMatchDiv(m) {
            const div = document.createElement('div');
            div.className = 'match';
            div.onclick = () => openModal(m.id);

            const p1Class = m.winner === m.p1 ? 'winner' : '';
            const p2Class = m.winner === m.p2 ? 'winner' : '';
            const p1 = m.p1 || 'TBD';
            const p2 = m.p2 || 'TBD';

            div.innerHTML = `
                <div class="player ${p1Class}">${p1}</div>
                <div class="player ${p2Class}">${p2}</div>
                <div class="table-info">${m.table}</div>
            `;
            return div;
        }

        // Modal
        function openModal(id) {
            currentMatchId = id;
            const m = matches[id];
            if (m.winner) return; // Already completed

            document.getElementById('modalTitle').textContent = 'Select Winner';
            document.getElementById('modalPlayers').textContent = `${m.p1 || 'TBD'} vs ${m.p2 || 'TBD'}`;

            const select = document.getElementById('winnerSelect');
            select.innerHTML = '';
            if (m.p1 && m.p1 !== 'BYE') {
                const opt = document.createElement('option');
                opt.value = m.p1;
                opt.textContent = m.p1;
                select.appendChild(opt);
            }
            if (m.p2 && m.p2 !== 'BYE') {
                const opt = document.createElement('option');
                opt.value = m.p2;
                opt.textContent = m.p2;
                select.appendChild(opt);
            }

            document.getElementById('tableSelect').value = m.table;
            document.getElementById('matchModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('matchModal').style.display = 'none';
        }

        function confirmWinner() {
            const m = matches[currentMatchId];
            const winner = document.getElementById('winnerSelect').value;
            if (!winner) return;

            m.winner = winner;
            m.table = document.getElementById('tableSelect').value;

            advanceWinner(m);
            dropLoser(m);

            closeModal();
            renderBracket();
        }

        // Save/Load
        function saveState() {
            localStorage.setItem('poolTournament', JSON.stringify({players, matches, format}));
            alert('Saved!');
        }

        function loadState() {
            const saved = localStorage.getItem('poolTournament');
            if (saved) {
                const data = JSON.parse(saved);
                players = data.players;
                matches = data.matches;
                format = data.format;
                renderPlayersList();
                renderBracket();
                alert('Loaded!');
            }
        }

        window.onload = () => document.getElementById('nameInput').focus();
    </script>
</body>
</html>
