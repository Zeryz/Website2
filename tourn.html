<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool Tournament Manager</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    /* Your cleaned CSS from earlier - full responsive tournament UI */
    body { padding: 0; margin: 0; font-family: sans-serif; font-size: 16px; background: #5394ad; }
    * { box-sizing: border-box; }
    /* ... (paste the full formatted CSS I sent you here) ... */
  </style>
</head>
<body>
  <div id="app">
    <!-- Your Vue app template here -->
    <div id="app_main">
      <header id="title" class="flex gap10 center">
        <div style="font-size: 20px;">
          <span style="color: yellow;">{{ currentTournament?.name || 'Pool Tournament Manager' }}</span>
          <span style="opacity: 0.5;"> {{ currentTournament?.start_date?.toLocaleDateString() }}</span>
        </div>
        <button @click="showPlayerList = !showPlayerList">Players: {{ players.length }}</button>
        <button v-if="canEdit" :disabled="!tournament.canStartNewRound" @click="createNextRound">
          {{ tournament.rounds.length ? 'Next Round' : 'Start Tournament' }}
        </button>
        <button v-if="debug && canEdit && !winner" @click="simulateRound">Simulate Round</button>
        <button v-if="debug && canEdit && !winner" @click="simulateAll">Simulate All</button>
        <button v-if="canEdit" @click="editTournament">Edit</button>
        <button v-if="debug && canEdit" class="danger" @click="resetTournament" 
                v-if="currentTournament?.rounds?.length">Reset All Rounds</button>
        <span class="grow"></span>
        <button @click="newTournament">New Tournament</button>
        <button @click="showHistory = true">History</button>
      </header>

      <!-- Tournament Brackets -->
      <div id="app_content">
        <div v-if="currentTournament" class="rounds">
          <div v-for="round in tournament.rounds" :key="round.number" class="round">
            <button class="round_name" :class="{ done: round.done, future: round.future }" 
                    @click="editRound(round)">
              Round {{ round.number }}
            </button>
            <div v-for="match in round.matches" :key="`${match.player1}_${match.player2 || ''}`" 
                 class="match" :class="{ done: !!match.winner }">
              <div class="match_player" @click="setWinner(match, match.player1)">
                <span class="player_label" :class="{ small: getPlayer(match.player1)?.name?.length > 15 }">
                  {{ getPlayer(match.player1)?.name || 'BYE' }}
                </span>
                <span class="player_status" :class="{ winner: match.winner === match.player1 }">‚úì</span>
              </div>
              <div v-if="match.player2" class="match_player" @click="setWinner(match, match.player2)">
                <span class="player_label" :class="{ small: getPlayer(match.player2)?.name?.length > 15 }">
                  {{ getPlayer(match.player2)?.name }}
                </span>
                <span class="player_status" :class="{ winner: match.winner === match.player2 }">‚úì</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Winner Announcement -->
        <div v-if="winner" class="winner-announcement center" style="padding: 40px; font-size: 24px; color: gold;">
          üèÜ Champion: {{ getPlayer(winner)?.name }} üèÜ
          <button @click="newTournament" style="margin-top: 20px;">New Tournament</button>
        </div>

        <!-- No Tournament Started -->
        <div v-else-if="!currentTournament" class="center" style="padding: 60px;">
          <h1>Welcome to Pool Tournament Manager</h1>
          <p>Double-elimination brackets for 8-ball, 9-ball, or any pool format.</p>
          <button class="primary" @click="newTournament" style="font-size: 20px; padding: 15px 30px;">
            Create New Tournament
          </button>
          <p style="margin-top: 20px; opacity: 0.8;">
            Features: Smart pairing, no repeat opponents, balanced byes, mobile-friendly, offline support.
          </p>
        </div>
      </div>
    </div>

    <!-- Player Stats Sidebar -->
    <div v-if="showPlayerList" class="player-sidebar" ref="playerSidebar">
      <div class="sidebar-header" @mousedown="startDrag">
        <h3>Player Stats ({{ players.length }})</h3>
        <button @click="showPlayerList = false" style="float: right;">‚úï</button>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th @click="sortBy('name')">Player</th>
              <th @click="sortBy('wins')">Wins</th>
              <th @click="sortBy('losses')">Losses</th>
              <th @click="sortBy('byes')">Byes</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="player in sortedPlayers" :key="player.id">
              <td>{{ player.name }}</td>
              <td>{{ player.wins }}</td>
              <td>{{ player.losses }}</td>
              <td>{{ player.byes }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Edit Tournament Dialog -->
    <div v-if="showEditDialog" class="dlgbg" ref="editDialog">
      <!-- Full dialog template from your app -->
    </div>

    <!-- History Dialog -->
    <div v-if="showHistory" class="dlgbg">
      <!-- Tournament history list -->
    </div>
  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    // Your TournamentManager class (cleaned from original)
    class TournamentManager {
      constructor(data = null) {
        this.name = data?.name || '';
        this.start_date = data?.start_date || new Date();
        this.players = data?.players || [];
        this.rounds = data?.rounds || [];
        this.edit_id = data?.edit_id || TournamentManager.generateId();
        this.ref = data?.ref || null;
        this.update_players();
      }

      static generateId() {
        return Math.random().toString(36).substr(2, 9);
      }

      update_players() {
        // Your full update_players logic here
        this.winner = null;
        // ... (all the player stats calculation)
      }

      createNextRound() {
        // Your round creation logic
      }

      setWinner(match, playerId) {
        // Winner setting logic
        this.update_players();
        this.save();
      }

      save() {
        // Save to localStorage
        const tournaments = JSON.parse(localStorage.getItem('poolTournaments') || '[]');
        const index = tournaments.findIndex(t => t.edit_id === this.edit_id);
        const data = this.toJSON();
        if (index >= 0) {
          tournaments[index] = data;
        } else {
          tournaments.push(data);
        }
        localStorage.setItem('poolTournaments', JSON.stringify(tournaments));
      }

      static load(id) {
        const tournaments = JSON.parse(localStorage.getItem('poolTournaments') || '[]');
        const data = tournaments.find(t => t.edit_id === id);
        return data ? new TournamentManager(data) : null;
      }

      static list() {
        return JSON.parse(localStorage.getItem('poolTournaments') || '[]');
      }

      static deleteOld() {
        // Delete tournaments older than 180 days
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - 180);
        let tournaments = JSON.parse(localStorage.getItem('poolTournaments') || '[]');
        tournaments = tournaments.filter(t => new Date(t.start_date) > cutoff);
        localStorage.setItem('poolTournaments', JSON.stringify(tournaments));
      }
    }

    // Vue App
    const app = createApp({
      setup() {
        const currentTournament = ref(null);
        const showPlayerList = ref(false);
        const showEditDialog = ref(false);
        const showHistory = ref(false);
        const debug = ref(false); // Enable via URL ?debug=true

        // Load from URL or localStorage
        onMounted(() => {
          const urlParams = new URLSearchParams(window.location.search);
          const id = urlParams.get('id');
          const editId = urlParams.get('edit_id');
          debug.value = urlParams.get('debug') === 'true';

          if (id) {
            currentTournament.value = TournamentManager.load(id);
            if (currentTournament.value && currentTournament.value.edit_id === editId) {
              // Editing
            }
          }

          TournamentManager.deleteOld(); // Cleanup old tournaments
        });

        const newTournament = () => {
          showEditDialog.value = true;
        };

        const editTournament = () => {
          showEditDialog.value = true;
        };

        return {
          currentTournament,
          showPlayerList,
          showEditDialog,
          showHistory,
          debug,
          newTournament,
          editTournament,
          // ... all your computed, methods
        };
      }
    });

    app.mount('#app');
  </script>
</body>
</html>
